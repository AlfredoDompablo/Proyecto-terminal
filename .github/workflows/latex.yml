# Nombre del flujo de trabajo
name: Compilar Tesis LaTeX a PDF

# Define cuándo se debe ejecutar
on:
  push:
    branches:
      - main          # Se ejecuta en 'push' a la rama 'main'
      - 'feature/**'  # Se ejecuta en 'push' a cualquier rama que empiece con 'feature/'
      - 'fix/**'      # Se ejecuta en 'push' a cualquier rama que empiece con 'fix/'

# Define los trabajos (jobs) que se ejecutarán
jobs:
  build_latex:
    # El tipo de máquina virtual
    runs-on: ubuntu-latest

    # Da permisos de escritura para crear el Release
    permissions:
      contents: write

    # La secuencia de pasos que realizará el trabajo
    steps:
      # Paso 1: Descarga una copia de tu repositorio
      - name: Checkout del Repositorio
        uses: actions/checkout@v4

      # Paso 2: Compila el archivo .tex para generar el PDF
      - name: Compilar documento LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          compiler: latexmk

      # Paso 3: Renombra el PDF de salida y guarda el nuevo nombre
      - name: Renombrar PDF de salida
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Si es la rama main, usa el número de versión
            NEW_NAME="Tesis-v${{ github.run_number }}.pdf"
          else
            # Si es otra rama, usa el nombre de la rama (reemplazando '/' por '-')
            BRANCH_NAME=$(echo ${{ github.ref_name }} | tr '/' '-')
            NEW_NAME="Tesis-Rama-${BRANCH_NAME}.pdf"
          fi
          mv main.pdf $NEW_NAME
          # Guarda el nuevo nombre en una variable de entorno para usarlo después
          echo "PDF_NAME=$NEW_NAME" >> $GITHUB_ENV

      # Paso 4: Este paso solo se ejecuta si la rama es 'main'
      - name: Crear Release y adjuntar PDF (Solo en Main)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Tesis PDF (Versión ${{ github.run_number }})
          body: |
            PDF generado a partir del último commit en main.
            Commit: `${{ github.sha }}`
          # Usa la variable con el nuevo nombre
          files: ${{ env.PDF_NAME }}
          prerelease: true

      # Paso 5: Este paso solo se ejecuta si la rama NO es 'main'
      - name: Subir PDF como artefacto (Solo en Ramas de Desarrollo)
        if: github.ref != 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          # Usa la variable para el nombre del artefacto
          name: ${{ env.PDF_NAME }}
          # Usa la variable para la ruta del archivo
          path: ${{ env.PDF_NAME }}