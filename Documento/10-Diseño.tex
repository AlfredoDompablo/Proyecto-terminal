\begin{comment}
\chapter{Diseño}
\section{Diseño de boya para nodos sensores y nodo concentrador}
\section{Diagrama de circuito fuente de alimentacion}
\section{Diagrama de circuitos de nodo sensor}
\section{Diagrama de circuitos de nodo concentrado}
\section{Diseño de boya para nodo sensor}
\section{Diagrama de comunicacion del nodo concentrador con el servidor}
\section{Diseño de Base de datos}
\section{Modelo Relacional}
\section{Arquitectura}
\section{Diagramas UML}
\section{Diagramas de caso de uso}
\section{Diagramas de secuencia}
\section{Diccionario de Datos}
\section{Diseño de Mock-up para la pagina web}
\section{Pagina principal}
\section{Diseño de la interfaz para la página Web}
\section{Integracion Final del Sistema}
\section{Escenario de pruebas}    
\end{comment}

%opcion 2

\chapter{Diseño}
\begin{comment}
\section{Diseño del Sistema}
\subsection{Arquitectura del Sistema}

\section{Diseño de Hardware}

\subsection{Diagrama eléctrico de los nodos}
\label{sec:diagrama_electrico}

La red está conformada por nodos sensores y un nodo concentrador. Cada nodo sensor se encarga de medir parámetros físico-químicos del agua y transmitir la información recopilada hacia el nodo final, el cual actúa como concentrador. Con base en los componentes analizados y seleccionados en capítulos anteriores, se presenta el diseño esquemático del circuito electrónico del nodo sensor (Figura~\ref{fig:esquema_nodo_sensor}).

\subsection*{Descripción general del circuito}

El circuito del nodo sensor se compone de dos microcontroladores principales: un \textbf{PIC16F1823} y un \textbf{Xiao ESP32-S3}. El primero se encarga del sensado y control energético, mientras que el segundo maneja la comunicación inalámbrica con el siguiente nodo (o concentrador) a través de un módulo \textbf{Wi-Fi HaLow FGH100M}.

\begin{itemize}
    \item \textbf{PIC16F1823}: gestiona la activación secuencial de los sensores mediante un demultiplexor \textbf{74HC238}, activando solo un sensor a la vez para minimizar el consumo energético. Los sensores analógicos (pH, conductividad, OD, turbidez) son activados por MOSFETs \textbf{AO3400A} y su señal de salida se dirige a entradas ADC del PIC.
    
    \item \textbf{Sensor de temperatura DS18B20}: se conecta directamente al PIC mediante una línea digital dedicada para adquisición por protocolo 1-Wire.

    \item \textbf{Demultiplexor 74HC238}: permite seleccionar cuál de los sensores analógicos se activa en cada momento, controlado por tres líneas digitales del PIC.

    \item \textbf{Xiao ESP32-S3}: se encarga de la comunicación inalámbrica. Recibe los datos procesados por el PIC a través de un canal \textbf{UART}, y los transmite al siguiente nodo o al concentrador mediante el módulo HaLow conectado en sus pines digitales.

    \item \textbf{Módulo HaLow FGH100M}: es operado por el Xiao ESP32 y sirve como interfaz de comunicación bajo el estándar IEEE 802.11ah.

    \item \textbf{Fuente de alimentación}: el sistema se alimenta desde una batería Li-ion de 3.7 V regulada por un cargador solar \textbf{CN3065}. La salida alimenta un convertidor \textbf{step-up} que genera 5V, y un LDO que provee 3.3V para los componentes lógicos.
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{Documento/Imagenes/Diseño/Diagramas electricos/Controller Sensor_fit.pdf}
\caption{Diagrama eléctrico del control de sensores.}
\label{fig:esquema_nodo_sensor}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{Documento/Imagenes/Diseño/Diagramas electricos/microcontroller_fit.pdf}
\caption{Diagrama eléctrico comunicación inalámbrica y fuente de alimentación.}
\label{fig:esquema_nodo_sensor2}
\end{figure}


\subsection*{Funcionamiento del sistema}

Durante cada ciclo de adquisición:

\begin{enumerate}
    \item El PIC activa uno por uno los sensores mediante el demultiplexor y sus respectivas compuertas MOSFET.
    \item Cada sensor permanece encendido aproximadamente 5 segundos para estabilizar la medición.
    \item El PIC adquiere los valores analógicos o digitales, almacena las lecturas y las envía por UART al Xiao ESP32.
    \item El Xiao ESP32 activa la cámara, captura una imagen (JPG), y empaqueta los datos sensados junto con la imagen.
    \item Finalmente, activa el módulo HaLow para transmitir toda la información al nodo siguiente o al nodo concentrador.
    \item Al finalizar, el sistema entra en modo \textit{sleep} hasta el próximo ciclo.
\end{enumerate}
\end{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: base de datos         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Diseño de la Base de Datos}
\label{sec:diseno_bd}

Con base en el análisis previo, se ha diseñado un esquema de base de datos relacional implementado sobre el motor \textbf{PostgreSQL} (alojado en AWS RDS). Este diseño tiene como objetivo garantizar la persistencia, integridad y disponibilidad de los datos generados por la Red Inalámbrica de Sensores y los resultados del procesamiento de visión artificial.

\subsection{Modelo Conceptual (Entidad-Relación)}
\label{subsec:modelo_er}

El modelo de datos se estructura en torno a tres entidades principales que reflejan la arquitectura del sistema:

\begin{enumerate}
    \item \textbf{Nodos (nodes):} Representa los dispositivos físicos (nodos sensores) desplegados en el río. Almacena su configuración estática y ubicación.
    \item \textbf{Lecturas de Sensores (sensor\_readings):} Almacena las series temporales de los parámetros físico-químicos y el estado de la batería, vinculadas a un nodo específico.
    \item \textbf{Detecciones de Residuos (waste\_detections):} Almacena los metadatos resultantes del análisis de imágenes (densidad de cobertura), la referencia a la imagen almacenada (URL) y la trazabilidad del modelo de IA.
\end{enumerate}

La Figura \ref{fig:diagrama_er} ilustra el Diagrama Entidad-Relación (ER) del sistema, mostrando las relaciones de ``uno a muchos'' ($1:N$) entre los nodos y sus mediciones/detecciones.

% \begin{figure}[h!]
%     \centering
%     % Reemplaza con tu archivo de imagen. Si no tienes uno, avísame para ayudarte a describirlo.
%     \includegraphics[width=0.7\linewidth]{Documento/Imagenes/Diseño/BD/entidad-relacion.pdf}
%     \caption{Diagrama Entidad-Relación (ER) de la base de datos del sistema de monitoreo.}
%     \label{fig:diagrama_er}
% \end{figure}
\begin{figure}[h]
    \centering
    \input{Documento/Imagenes/Diseño/BD/entidad-relacion.tex}
    \caption{Diagrama Entidad-Relación (ER) de la base de datos del sistema de monitoreo.}
    \label{fig:diagrama_er}
\end{figure}


\subsection{Diseño Lógico y Diccionario de Datos}
\label{subsec:diccionario_datos}

A continuación, se detalla la estructura física de las tablas diseñadas, especificando tipos de datos y restricciones para asegurar la integridad referencial.

\subsubsection*{Tabla: Nodes (Nodos)}
Esta tabla actúa como catálogo maestro de los dispositivos autorizados en la red.
\input{Documento/Tablas/DiccionarioBD/Nodos}

\subsubsection*{Tabla: Sensor\_Readings (Lecturas de Sensores)}
Almacena el histórico de mediciones. Se crean índices en \texttt{timestamp} y \texttt{node\_id} para optimizar las consultas de series de tiempo (RF25).

\input{Documento/Tablas/DiccionarioBD/sensor}

\subsubsection*{Tabla: Waste\_Detections (Detecciones de Residuos)}
Almacena los resultados del análisis y la evidencia visual. Se opta por almacenar la imagen directamente en la base de datos (BLOB) para garantizar la integridad referencial y simplificar la arquitectura del prototipo.

\input{Documento/Tablas/DiccionarioBD/waste}


\subsubsection*{Tabla: Users (Usuarios del Sistema)}
Almacena las credenciales de acceso para los administradores y el dueño del sistema. El control de privilegios se gestiona mediante el campo de rol.

\input{Documento/Tablas/DiccionarioBD/user}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: casos de uso         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Diagramas de Casos de Uso}
\label{sec:diagramas_casos_uso}

Para modelar el comportamiento funcional del sistema y las interacciones entre los actores (usuarios, hardware y entorno) con los distintos módulos, se han elaborado diagramas de casos de uso basados en los requerimientos definidos en la Sección \ref{sec:analisis_requerimientos}. Debido a la naturaleza distribuida del sistema, se presentan tres vistas correspondientes a los subsistemas principales.

\subsection{Casos de Uso del Subsistema de Adquisición (WSN)}
La Figura \ref{fig:uc_wsn} ilustra las operaciones autónomas realizadas por los nodos sensores y el nodo concentrador (Gateway). Se destaca el rol del \textbf{Entorno Fluvial} como un actor externo que provee los estímulos físicos (parámetros y luz para la imagen) que activan el proceso de monitoreo. El diagrama muestra el flujo de datos en la topología lineal multisalto, donde cada nodo intermedio no solo genera su información, sino que también recibe y retransmite datos de sus vecinos (\textit{store-and-forward}).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Documento/Imagenes/Diseño/UML/UMLNodos.pdf}
    \caption{Diagrama de casos de uso para la Red Inalámbrica de Sensores y el Gateway, mostrando la interacción con el entorno y el relevo de datos.}
    \label{fig:uc_wsn}
\end{figure}

\subsection{Casos de Uso del Servidor y Procesamiento}
La Figura \ref{fig:uc_backend} detalla el flujo de información en el servidor (Backend). Este subsistema actúa como el núcleo de procesamiento, iniciando su operación con la recepción de datos desde el Gateway. Se ilustra la secuencia de procesamiento que incluye el reensamblaje de imágenes fragmentadas, la ejecución de los algoritmos de Inteligencia Artificial (segmentación de residuos) y el almacenamiento persistente de los resultados para su posterior consulta vía API.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Documento/Imagenes/Diseño/UML/servidor.pdf}
    \caption{Diagrama de casos de uso para el Backend, abarcando la ingesta, procesamiento de IA y almacenamiento de datos.}
    \label{fig:uc_backend}
\end{figure}

\subsection{Casos de Uso de la Interfaz Web}
La Figura \ref{fig:uc_webapp} muestra las interacciones disponibles para los usuarios humanos a través de la plataforma web. Se modelan tres niveles de actores:
\begin{itemize}
    \item \textbf{Usuario Público:} Con acceso libre a la visualización de datos actuales, históricos y evidencia visual.
    \item \textbf{Administrador:} Hereda los permisos de visualización y añade capacidades de gestión sobre los nodos sensores (altas, bajas, configuración) previo inicio de sesión.
    \item \textbf{Dueño (Owner):} Actor con el máximo nivel de privilegios, capaz de gestionar las cuentas de los administradores del sistema.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{Documento/Imagenes/Diseño/UML/aplicacionWeb.pdf}
    \caption{Diagrama de casos de uso para la Aplicación Web, detallando los roles de usuario y sus privilegios.}
    \label{fig:uc_webapp}
\end{figure}





\begin{comment}
\section{Diseño de Software}
\begin{table}[H]
\centering
\caption{Tabla Nodo.}
\label{tab:usuario}
\begin{tabular}{|l|l|l|}
\hline
\textbf{Campo}              & \textbf{Tipo de dato} & \textbf{Llave}   \\ \hline
idNodo                  & int                   & primaria         \\ \hline
Nombre                    & varchar               & N/A              \\ \hline
apellido                  & varchar               & N/A              \\ \hline
seg\_apellido             & varchar               & N/A              \\ \hline
correo                    & varchar               & N/A              \\ \hline
fecha\_nacimiento         & date                  & N/A              \\ \hline
genero                    & varchar               & N/A              \\ \hline
bandera\_administrador    & tinyint               & N/A              \\ \hline
nodo                      & int                   & N/A              \\ \hline
\end{tabular}
\end{table}

\subsection{Conexión entre nodos, concentrador y servidor}.

En el sistema propuesto, los nodos sensores distribuidos a lo largo del entorno fluvial establecen comunicación con un nodo concentrador central mediante una red inalámbrica local basada en el estándar Wi-Fi HaLow (IEEE 802.11ah). Esta tecnología opera en la banda sub-1 GHz, lo cual le otorga ventajas significativas en términos de alcance (hasta 1 km en condiciones ideales) y penetración en entornos con vegetación densa, además de un consumo energético moderado que favorece la operación autónoma con baterías o paneles solares.

El nodo concentrador cumple una función crítica dentro de la arquitectura, ya que actúa como gateway inalámbrico. Es decir, se encarga de recibir la información sensorial proveniente de los nodos HaLow y reenviarla al servidor central utilizando una interfaz de red externa. Esta interfaz puede implementarse mediante un módulo de red celular (4G/5G), ideal para zonas con baja infraestructura de conectividad, o a través de una red WLAN convencional (2.4/5 GHz) disponible en estaciones fijas cercanas al sitio de monitoreo.

Para establecer la comunicación entre el nodo concentrador y el servidor, se asume que el concentrador cuenta con dicha interfaz de red externa, permitiendo el envío de datos a través del protocolo HTTP. Esta suposición garantiza la interoperabilidad con servicios web modernos y facilita la integración con plataformas de almacenamiento, análisis o visualización de datos.

Una vez recibidos, los datos son procesados por el servidor y almacenados en una base de datos estructurada, permitiendo su consulta posterior, análisis automatizado o incluso la generación de comandos que puedan enviarse de regreso a los nodos sensores, habilitando así una comunicación bidireccional dentro del sistema.
\end{comment}

%\subsection{Base de datos}
%\subsubsection{Diseño de base de datos}
%\subsubsection{Modelo Relacional}
%\subsubsection{Diccionario de datos}

%\section{Diseño de Comunicación}
%\subsection{Diagrama de comunicación del nodo concentrador con el servidor}

%\section{Diseño de Interfaces de Usuario}
%\subsection{Diseño de Mock-up para la página web}
%\subsection{Página principal}

%\section{Modelado del Sistema}
%\subsection{Diagramas UML}
%\subsubsection{Diagramas de caso de uso}
%\subsubsection{Diagramas de secuencia}

%\section{Integración y Pruebas}
%\subsection{Integración final del sistema}
%\subsection{Escenario de pruebas}
