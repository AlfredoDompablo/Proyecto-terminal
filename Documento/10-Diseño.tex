\begin{comment}
\chapter{Diseño}
\section{Diseño de boya para nodos sensores y nodo concentrador}
\section{Diagrama de circuito fuente de alimentacion}
\section{Diagrama de circuitos de nodo sensor}
\section{Diagrama de circuitos de nodo concentrado}
\section{Diseño de boya para nodo sensor}
\section{Diagrama de comunicacion del nodo concentrador con el servidor}
\section{Diseño de Base de datos}
\section{Modelo Relacional}
\section{Arquitectura}
\section{Diagramas UML}
\section{Diagramas de caso de uso}
\section{Diagramas de secuencia}
\section{Diccionario de Datos}
\section{Diseño de Mock-up para la pagina web}
\section{Pagina principal}
\section{Diseño de la interfaz para la página Web}
\section{Integracion Final del Sistema}
\section{Escenario de pruebas}    
\end{comment}

%opcion 2

\chapter{Diseño}
\begin{comment}
\section{Diseño del Sistema}
\subsection{Arquitectura del Sistema}

\section{Diseño de Hardware}

\subsection{Diagrama eléctrico de los nodos}
\label{sec:diagrama_electrico}

La red está conformada por nodos sensores y un nodo concentrador. Cada nodo sensor se encarga de medir parámetros físico-químicos del agua y transmitir la información recopilada hacia el nodo final, el cual actúa como concentrador. Con base en los componentes analizados y seleccionados en capítulos anteriores, se presenta el diseño esquemático del circuito electrónico del nodo sensor (Figura~\ref{fig:esquema_nodo_sensor}).

\subsection*{Descripción general del circuito}

El circuito del nodo sensor se compone de dos microcontroladores principales: un \textbf{PIC16F1823} y un \textbf{Xiao ESP32-S3}. El primero se encarga del sensado y control energético, mientras que el segundo maneja la comunicación inalámbrica con el siguiente nodo (o concentrador) a través de un módulo \textbf{Wi-Fi HaLow FGH100M}.

\begin{itemize}
    \item \textbf{PIC16F1823}: gestiona la activación secuencial de los sensores mediante un demultiplexor \textbf{74HC238}, activando solo un sensor a la vez para minimizar el consumo energético. Los sensores analógicos (pH, conductividad, OD, turbidez) son activados por MOSFETs \textbf{AO3400A} y su señal de salida se dirige a entradas ADC del PIC.
    
    \item \textbf{Sensor de temperatura DS18B20}: se conecta directamente al PIC mediante una línea digital dedicada para adquisición por protocolo 1-Wire.

    \item \textbf{Demultiplexor 74HC238}: permite seleccionar cuál de los sensores analógicos se activa en cada momento, controlado por tres líneas digitales del PIC.

    \item \textbf{Xiao ESP32-S3}: se encarga de la comunicación inalámbrica. Recibe los datos procesados por el PIC a través de un canal \textbf{UART}, y los transmite al siguiente nodo o al concentrador mediante el módulo HaLow conectado en sus pines digitales.

    \item \textbf{Módulo HaLow FGH100M}: es operado por el Xiao ESP32 y sirve como interfaz de comunicación bajo el estándar IEEE 802.11ah.

    \item \textbf{Fuente de alimentación}: el sistema se alimenta desde una batería Li-ion de 3.7 V regulada por un cargador solar \textbf{CN3065}. La salida alimenta un convertidor \textbf{step-up} que genera 5V, y un LDO que provee 3.3V para los componentes lógicos.
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{Documento/Imagenes/Diseño/Diagramas electricos/Controller Sensor_fit.pdf}
\caption{Diagrama eléctrico del control de sensores.}
\label{fig:esquema_nodo_sensor}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{Documento/Imagenes/Diseño/Diagramas electricos/microcontroller_fit.pdf}
\caption{Diagrama eléctrico comunicación inalámbrica y fuente de alimentación.}
\label{fig:esquema_nodo_sensor2}
\end{figure}


\subsection*{Funcionamiento del sistema}

Durante cada ciclo de adquisición:

\begin{enumerate}
    \item El PIC activa uno por uno los sensores mediante el demultiplexor y sus respectivas compuertas MOSFET.
    \item Cada sensor permanece encendido aproximadamente 5 segundos para estabilizar la medición.
    \item El PIC adquiere los valores analógicos o digitales, almacena las lecturas y las envía por UART al Xiao ESP32.
    \item El Xiao ESP32 activa la cámara, captura una imagen (JPG), y empaqueta los datos sensados junto con la imagen.
    \item Finalmente, activa el módulo HaLow para transmitir toda la información al nodo siguiente o al nodo concentrador.
    \item Al finalizar, el sistema entra en modo \textit{sleep} hasta el próximo ciclo.
\end{enumerate}
\end{comment}

\section{Diseño del Circuito Electrónico}
\label{sec:diseno_circuito}

El diseño electrónico del nodo sensor implementa una arquitectura de \textbf{procesamiento distribuido} utilizando dos microcontroladores para separar las tareas críticas de comunicación y sensado de las tareas intensivas de adquisición de imágenes. El diagrama esquemático general se presenta en la Figura \ref{fig:diagrama_circuito}.

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.95\linewidth]{Documento/Imagenes/Diseño/circuitos/circuitopt_1.pdf}
    \caption{Diagrama esquemático del nodo sensor, mostrando la interconexión entre microcontroladores y el bloque de sensores.}
    \label{fig:diagrama_circuito}
\end{figure}

El sistema se estructura en tres bloques funcionales interconectados:

\subsection{Unidad Central de Control y Telemetría (MCU1)}
El núcleo del nodo es la plataforma \textbf{Heltec Wireless Tracker V1.1} (basada en ESP32-S3 + SX1262). Este microcontrolador actúa como el coordinador principal del sistema y es responsable de:

\begin{itemize}
    \item \textbf{Gestión de Sensores:} Controla directamente el encendido y apagado de los sensores mediante un multiplexor y realiza la lectura de las señales analógicas y digitales.
    \item \textbf{Comunicación LoRa:} Administra el transceptor SX1262 integrado para el envío de paquetes de datos y fragmentos de imagen a la red.
    \item \textbf{Geolocalización:} Obtiene las coordenadas del módulo GNSS integrado.
    \item \textbf{Coordinación de Imagen:} Envía la orden de captura al módulo de cámara (MCU2) y recibe el flujo de bytes de la imagen procesada vía UART.
\end{itemize}

\subsection{Módulo de Adquisición de Imágenes (MCU2)}
Para aislar el manejo de la cámara y asegurar la estabilidad del sistema principal, se utiliza un módulo \textbf{ESP32-CAM} dedicado exclusivamente a la visión. Sus funciones son:
\begin{itemize}
    \item \textbf{Control de la Cámara:} Inicializa y configura el sensor OV5640.
    \item \textbf{Captura y Compresión:} Toma la fotografía en alta resolución y realiza la compresión JPEG en hardware.
    \item \textbf{Transmisión Serial:} Envía la imagen comprimida al MCU1 a través de un puerto serie de alta velocidad, actuando como un periférico esclavo.
\end{itemize}

\subsection{Subsistema de Alimentación y Regulación}
\label{subsec:diseno_alimentacion}

Para garantizar la estabilidad operativa de los microcontroladores y la precisión de las mediciones analógicas, el diseño implementa una arquitectura de alimentación distribuida que gestiona la conversión de energía y los niveles de voltaje.

\begin{enumerate}
    \item \textbf{Gestión de Carga Solar:} Se integra el módulo basado en el controlador CN3065, encargado de administrar el flujo de energía desde el panel solar hacia la batería LiPo (\SI{3.7}{\volt}). Este módulo protege la batería contra sobrecargas y optimiza la corriente de carga disponible.

    \item \textbf{Regulación Principal (Bus de \SI{5}{\volt}):} Dado que el voltaje de la batería varía durante la descarga (\SIrange{3.2}{4.2}{\volt}), se utiliza un convertidor DC-DC tipo \textit{Step-Up} (Boost) para elevar y estabilizar la tensión a \textbf{\SI{5}{\volt}}. Este bus alimenta las entradas de potencia de las placas de desarrollo principales:
    \begin{itemize}
        \item \textbf{Heltec Wireless Tracker (MCU1):} Se alimenta a través de su pin de \SI{5}{\volt}, permitiendo que su regulador LDO interno genere el voltaje lógico de \SI{3.3}{\volt} limpio para el ESP32 y la radio LoRa.
        \item \textbf{ESP32-CAM (MCU2):} Recibe \SI{5}{\volt} estables para garantizar el correcto funcionamiento de la cámara, evitando reinicios por caídas de tensión (\textit{Brown-out}).
    \end{itemize}
\end{enumerate}

\subsection{Subsistema de Sensores y Eficiencia Energética}
\label{subsec:diseno_sensores_control}

Los sensores analógicos y digitales se alimentan a \textbf{\SI{3.3}{\volt}} para igualar los niveles de referencia del Conversor Analógico-Digital (ADC) del ESP32-S3. Para optimizar el consumo de corriente (que puede ser elevado en sensores como OD o Turbidez), se implementa una estrategia de energía bajo demanda (\textit{Power Gating}) controlada por el MCU1.

\begin{enumerate}
    \item \textbf{Multiplexación de Potencia:} El circuito incorpora un decodificador/demultiplexor 74HC238 y un arreglo de transistores MOSFET que actúan como interruptores de potencia.
    
    \item \textbf{Lógica de Control:}
    \begin{itemize}
        \item El MCU1 envía la dirección binaria del sensor requerido al multiplexor.
        \item La salida correspondiente del 74HC238 activa la compuerta (\textit{Gate}) del transistor MOSFET asociado a ese sensor específico.
        \item Esto permite el paso de los \SI{3.3}{\volt} únicamente al sensor seleccionado, manteniendo los demás físicamente desconectados y con consumo cero.
    \end{itemize}

    \item \textbf{Adquisición:} Una vez estabilizado el sensor activo, el MCU1 realiza la lectura a través de sus entradas analógicas (ADC) o digitales (OneWire) y procede inmediatamente a apagar el sensor antes de activar el siguiente o entrar en reposo.
\end{enumerate}

Esta arquitectura garantiza que el consumo pico del sistema se mantenga dentro de los límites soportados por la batería y evita interferencias cruzadas entre las lecturas de los sensores.

\subsection{Diseño Electrónico del Nodo Concentrador (Gateway)}
\label{subsec:diseno_gateway}

Para el nodo concentrador, se ha seleccionado la misma plataforma de hardware que en los nodos sensores: la \textbf{Heltec Wireless Tracker V1.1}. Esta decisión se fundamenta en la capacidad de procesamiento dual del chip ESP32-S3 y su conectividad híbrida nativa (LoRa + Wi-Fi), lo que permite implementar toda la lógica del Gateway en un solo dispositivo integrado (System-on-Chip).

El funcionamiento del concentrador se diseña bajo un esquema de concurrencia de tareas aprovechando los dos núcleos del microcontrolador y el sistema operativo en tiempo real (FreeRTOS):

\begin{enumerate}
    \item \textbf{Interfaz LoRa (Radiofrecuencia):}
    Una tarea de alta prioridad se dedica exclusivamente a gestionar el transceptor SX1262 en modo de recepción continua.
    \begin{itemize}
        \item Escucha el espectro para detectar preámbulos válidos con la \textit{Sync Word} de la red.
        \item Recibe los paquetes de telemetría y los fragmentos de imagen, almacenándolos temporalmente en un buffer circular en la memoria RAM (o PSRAM si el volumen de imágenes es alto).
        \item Realiza el reensamblaje lógico de los archivos fragmentados.
    \end{itemize}

    \item \textbf{Interfaz Wi-Fi (Enlace de Bajada/Backhaul):}
    Una segunda tarea gestiona la pila de protocolos TCP/IP utilizando la radio Wi-Fi de \SI{2.4}{\giga\hertz} integrada en el ESP32-S3.
    \begin{itemize}
        \item Mantiene la conexión con el punto de acceso local o router móvil.
        \item Empaqueta los datos recibidos en formato JSON.
        \item Realiza la transmisión segura (HTTPS/MQTT) hacia el servidor en la nube (Backend) para su almacenamiento y visualización.
    \end{itemize}
\end{enumerate}

Esta arquitectura monoplaca reduce significativamente la complejidad del montaje físico, el costo del sistema y el tamaño del dispositivo final. Al ubicarse en un punto con infraestructura, la alimentación se suministra de forma continua a través de su puerto \textbf{USB Tipo-C} (\SI{5}{\volt}), garantizando una operación ininterrumpida sin depender de baterías externas.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%        SECCIÓN: diseño del protocolo             % 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Diseño del Protocolo de Comunicación}
\label{sec:diseno_protocolo}

Dada la arquitectura de red lineal P2P y las limitaciones de ancho de banda de la modulación LoRa, se ha diseñado un protocolo de comunicación a medida que gestiona dos tipos de tráfico con requerimientos opuestos: la telemetría ligera (sensores) y la transmisión pesada (imágenes).

\subsection{Estructura de la Trama de Datos}
\label{subsec:estructura_trama}

Para optimizar el uso del \textit{payload} (carga útil), se define una estructura de trama binaria compacta. Cada paquete transmitido por la radio SX1262 sigue el siguiente formato general:

\begin{table}[h!]
\centering
\caption{Estructura general del paquete LoRa P2P.}
\label{tab:trama_lora}
\renewcommand{\arraystretch}{1.2}
\begin{tabular}{|c|c|c|c|c|}
\hline
\textbf{Cabecera (3B)} & \textbf{Origen (1B)} & \textbf{Tipo (1B)} & \textbf{Secuencia (2B)} & \textbf{Carga Útil (Variable)} \\
\hline
Sync Word & Node ID & DataType & Pkt Index & Datos / Fragmento \\
\hline
\end{tabular}
\end{table}

Donde:
\begin{itemize}
    \item \textbf{Cabecera (Sync Word):} Secuencia de 3 bytes utilizada para identificar el inicio de la trama y filtrar paquetes de otras redes LoRa que operen en la misma frecuencia.
    \item \textbf{Origen (Node ID):} Identificador único del nodo que genera los datos.
    \item \textbf{Tipo (DataType):} Indica el contenido: \texttt{0x01} (Sensores), \texttt{0x02} (Inicio Imagen), \texttt{0x03} (Fragmento Imagen), \texttt{0x04} (Fin Imagen).
    \item \textbf{Secuencia (Pkt Index):} Contador para ordenar los fragmentos en el receptor.
\end{itemize}

\subsection{Transmisión de Datos de Sensores (Telemetría)}
Los datos de los sensores (pH, OD, Turbidez, Temperatura, Batería) y la geolocalización (GNSS) se empaquetan en una sola trama de tamaño fijo ($\approx \SI{24}{bytes}$). Esta trama se transmite en una sola ráfaga LoRa, con un tiempo en el aire mínimo ($\approx \SI{9}{\milli\second}$), garantizando la máxima eficiencia energética.

\subsection{Transmisión de Imágenes mediante Fragmentación}
\label{subsec:transmision_fragmentada}

La transmisión de evidencia visual presenta el mayor desafío técnico. Se establece una resolución de captura SVGA 800x600 píxeles, la cual ofrece un balance adecuado entre detalle visual y tamaño de archivo. Tras una compresión JPEG eficiente realizada por el ESP32-S3, se obtiene un archivo binario promedio de \SI{90}{kB}.

Dado que este tamaño excede por mucho la Unidad Máxima de Transmisión (MTU) de LoRa (típicamente \SI{255}{bytes}), se implementa un algoritmo de Fragmentación y Reensamblaje inspirado en la metodología de Jebril et al..\cite{jebril2018overcoming}

El proceso de diseño, ilustrado en la Figura \ref{fig:flujo_fragmentacion}, consta de las siguientes etapas:

\begin{enumerate}
    \item \textbf{Captura y Compresión:} El MCU captura la imagen en resolución SVGA y la comprime en formato JPEG, almacenando el archivo binario (\SI{\approx 90}{kB}) en la memoria RAM/PSRAM.
    \item \textbf{División (Splitting):} El archivo binario se divide lógicamente en bloques de datos de tamaño $N$ (donde $N < \text{MTU LoRa}$, ej. \SI{200}{bytes}). Para una imagen de \SI{90}{kB}, esto resulta en aproximadamente 450 a 460 paquetes.
    \item \textbf{Encapsulamiento:} A cada bloque se le añade un índice de secuencia ($1, 2, ..., K$) en la cabecera para permitir su reordenamiento y la detección de paquetes perdidos.
    \item \textbf{Transmisión Secuencial:} Los fragmentos se envían uno tras otro a través del transceptor SX1262. Se introduce un pequeño retardo (\textit{delay}) entre paquetes para evitar saturar el buffer del receptor.
    \item \textbf{Reensamblaje en Destino:} El nodo receptor (o Gateway) almacena los fragmentos entrantes en un buffer. Al recibir el paquete de "Fin de Imagen", concatena los fragmentos ordenados por su índice para reconstruir el archivo JPEG original.
\end{enumerate}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Documento/Imagenes/Diseño/UML/flujo_fragmentacion.pdf}
    \caption{Diagrama del proceso de fragmentación de imagen para transmisión sobre LoRa P2P.}
    \label{fig:flujo_fragmentacion}
\end{figure}

Esta estrategia hace viable la transmisión de archivos de gran tamaño a través de un canal de banda estrecha, superando las estrictas restricciones de tamaño de paquete (MTU) inherentes a la tecnología LoRa y garantizando la reconstrucción íntegra de la evidencia visual en el nodo concentrador.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: base de datos         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Diseño de la Base de Datos}
\label{sec:diseno_bd}

Con base en el análisis previo, se ha diseñado un esquema de base de datos relacional implementado sobre el motor \textbf{PostgreSQL} (alojado en AWS RDS). Este diseño tiene como objetivo garantizar la persistencia, integridad y disponibilidad de los datos generados por la Red Inalámbrica de Sensores y los resultados del procesamiento de visión artificial.

\subsection{Modelo Conceptual (Entidad-Relación)}
\label{subsec:modelo_er}

El modelo de datos se estructura en torno a tres entidades principales que reflejan la arquitectura del sistema:

\begin{enumerate}
    \item \textbf{Nodos (nodes):} Representa los dispositivos físicos (nodos sensores) desplegados en el río. Almacena su configuración estática y ubicación.
    \item \textbf{Lecturas de Sensores (sensor\_readings):} Almacena las series temporales de los parámetros físico-químicos y el estado de la batería, vinculadas a un nodo específico.
    \item \textbf{Detecciones de Residuos (waste\_detections):} Almacena los metadatos resultantes del análisis de imágenes (densidad de cobertura), la referencia a la imagen almacenada (URL) y la trazabilidad del modelo de IA.
\end{enumerate}

La Figura \ref{fig:diagrama_er} ilustra el Diagrama Entidad-Relación (ER) del sistema, mostrando las relaciones de ``uno a muchos'' ($1:N$) entre los nodos y sus mediciones/detecciones.

% \begin{figure}[h!]
%     \centering
%     % Reemplaza con tu archivo de imagen. Si no tienes uno, avísame para ayudarte a describirlo.
%     \includegraphics[width=0.7\linewidth]{Documento/Imagenes/Diseño/BD/entidad-relacion.pdf}
%     \caption{Diagrama Entidad-Relación (ER) de la base de datos del sistema de monitoreo.}
%     \label{fig:diagrama_er}
% \end{figure}
\begin{figure}[h]
    \centering
    \input{Documento/Imagenes/Diseño/BD/entidad-relacion.tex}
    \caption{Diagrama Entidad-Relación (ER) de la base de datos del sistema de monitoreo.}
    \label{fig:diagrama_er}
\end{figure}


\subsection{Diseño Lógico y Diccionario de Datos}
\label{subsec:diccionario_datos}

A continuación, se detalla la estructura física de las tablas diseñadas, especificando tipos de datos y restricciones para asegurar la integridad referencial.

\subsubsection*{Tabla: Nodes (Nodos)}
Esta tabla actúa como catálogo maestro de los dispositivos autorizados en la red.
\input{Documento/Tablas/DiccionarioBD/Nodos}

\subsubsection*{Tabla: Sensor\_Readings (Lecturas de Sensores)}
Almacena el histórico de mediciones. Se crean índices en \texttt{timestamp} y \texttt{node\_id} para optimizar las consultas de series de tiempo (RF25).

\input{Documento/Tablas/DiccionarioBD/sensor}

\subsubsection*{Tabla: Waste\_Detections (Detecciones de Residuos)}
Almacena los resultados del análisis y la evidencia visual. Se opta por almacenar la imagen directamente en la base de datos (BLOB) para garantizar la integridad referencial y simplificar la arquitectura del prototipo.

\input{Documento/Tablas/DiccionarioBD/waste}


\subsubsection*{Tabla: Users (Usuarios del Sistema)}
Almacena las credenciales de acceso para los administradores y el dueño del sistema. El control de privilegios se gestiona mediante el campo de rol.

\input{Documento/Tablas/DiccionarioBD/user}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: casos de uso         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Diagramas de Casos de Uso}
\label{sec:diagramas_casos_uso}

Para modelar el comportamiento funcional del sistema y las interacciones entre los actores (usuarios, hardware y entorno) con los distintos módulos, se han elaborado diagramas de casos de uso basados en los requerimientos definidos en la Sección \ref{sec:analisis_requerimientos}. Debido a la naturaleza distribuida del sistema, se presentan tres vistas correspondientes a los subsistemas principales.

\subsection{Casos de Uso del Subsistema de Adquisición (WSN)}
La Figura \ref{fig:uc_wsn} ilustra las operaciones autónomas realizadas por los nodos sensores y el nodo concentrador (Gateway). Se destaca el rol del \textbf{Entorno Fluvial} como un actor externo que provee los estímulos físicos (parámetros y luz para la imagen) que activan el proceso de monitoreo. El diagrama muestra el flujo de datos en la topología lineal multisalto, donde cada nodo intermedio no solo genera su información, sino que también recibe y retransmite datos de sus vecinos (\textit{store-and-forward}).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Documento/Imagenes/Diseño/UML/UMLNodos.pdf}
    \caption{Diagrama de casos de uso para la Red Inalámbrica de Sensores y el Gateway, mostrando la interacción con el entorno y el relevo de datos.}
    \label{fig:uc_wsn}
\end{figure}

\subsection{Casos de Uso del Servidor y Procesamiento}
La Figura \ref{fig:uc_backend} detalla el flujo de información en el servidor (Backend). Este subsistema actúa como el núcleo de procesamiento, iniciando su operación con la recepción de datos desde el Gateway. Se ilustra la secuencia de procesamiento que incluye el reensamblaje de imágenes fragmentadas, la ejecución de los algoritmos de Inteligencia Artificial (segmentación de residuos) y el almacenamiento persistente de los resultados para su posterior consulta vía API.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Documento/Imagenes/Diseño/UML/servidor.pdf}
    \caption{Diagrama de casos de uso para el Backend, abarcando la ingesta, procesamiento de IA y almacenamiento de datos.}
    \label{fig:uc_backend}
\end{figure}

\subsection{Casos de Uso de la Interfaz Web}
La Figura \ref{fig:uc_webapp} muestra las interacciones disponibles para los usuarios humanos a través de la plataforma web. Se modelan tres niveles de actores:
\begin{itemize}
    \item \textbf{Usuario Público:} Con acceso libre a la visualización de datos actuales, históricos y evidencia visual.
    \item \textbf{Administrador:} Hereda los permisos de visualización y añade capacidades de gestión sobre los nodos sensores (altas, bajas, configuración) previo inicio de sesión.
    \item \textbf{Dueño (Owner):} Actor con el máximo nivel de privilegios, capaz de gestionar las cuentas de los administradores del sistema.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{Documento/Imagenes/Diseño/UML/aplicacionWeb.pdf}
    \caption{Diagrama de casos de uso para la Aplicación Web, detallando los roles de usuario y sus privilegios.}
    \label{fig:uc_webapp}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: Diagramas de secuencia       %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Digramas de secuencias}

\subsection{Secuencia del nodo sensor}

En la \ref{fig:SDNodosensor}, se muestra el diagrama de secuencia del ciclo de monitorización del nodo sensor describe las interacciones entre los componentes internos y los elementos de comunicación del nodo.  El proceso comienza cuando el temporizador despierta al microcontrolador.  
El microcontrolador activa un sensor, espera a que se estabilice, lee el parámetro correspondiente, guarda el valor en un buffer de memoria y después desactiva el sensor.  Este ciclo se repite para cada uno de los sensores de calidad del agua (temperatura, turbidez, pH, oxígeno disuelto y conductividad) mediante un fragmento de bucle.  A continuación, el microcontrolador activa la cámara integrada, captura una imagen de la superficie y la fragmenta en bloques para su transmisión posterior.  
Los datos de los sensores y los fragmentos de la imagen se empaquetan en un mismo mensaje y se almacenan temporalmente.  El microcontrolador activa el transceptor LoRa, transmite el paquete al nodo vecino y, tras recibir la confirmación, desactiva el transceptor.  
Finalmente, vuelve a un modo de bajo consumo (\emph{sleep}) hasta el próximo ciclo de muestreo.  Este comportamiento se ajusta a la estructura de un nodo de medición WSN, que reúne componentes como la radio, la batería, el microcontrolador y la interfaz con los sensores.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Documento/Imagenes/Diseño/UML/SD Nodo Sensor - Página 1.pdf}
    \caption{Diagrama de secuencia del nodo sensor, detallando el flujo.}
    \label{fig:SDNodosensor}
\end{figure}

\subsection{Secuencia de la red inalámbrica de sensores}

El diagrama de secuencia de la red inalámbrica de sensores (WSN), \ref{fig:SDWSN}, ilustra la transmisión multi‑salto de paquetes a lo largo de la cadena de nodos. Cada nodo sensor genera sus propias mediciones y, cuando corresponde, las imágenes capturadas. A continuación envía este paquete al nodo siguiente de la cadena, que lo recibe, agrega sus propias mediciones y reenvía el conjunto ampliado al nodo posterior. 
De este modo, los datos se acumulan a medida que avanzan hacia la pasarela o nodo concentrador.  Este comportamiento responde al diseño de las WSN, en el que los nodos de medición están conectados de forma inalámbrica y la pasarela se encarga de recopilar los datos de cada nodo y enviarlos al servidor central.  Tras cada envío, el nodo receptor confirma la recepción para garantizar la fiabilidad de la comunicación.  
Cuando el paquete consolidado llega al concentrador, éste lo transmite al servidor para su almacenamiento y procesamiento.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Documento/Imagenes/Diseño/UML/SDWSN.pdf}
    \caption{Diagrama de secuencia de la red inalámbrica de sensores, detallando la transmisión de datos entre nodos sensores}
    \label{fig:SDWSN}
\end{figure}

\subsection{Secuencia de la consulta del usuario}

El diagrama de secuencia en la \ref{fig:SD User}, representa el proceso de obtención de datos y visualización en el navegador por parte del usuario. Cuando el usuario accede a la aplicación web, el frontend muestra un panel de información y ofrece diferentes opciones de visualización. Al seleccionar una opción, la interfaz realiza una petición al APIREST alojado en el servidor.  El API transmite la solicitud al backend, que procesa los parámetros recibidos y consulta la base de datos para recuperar las mediciones y los resultados de la detección de residuos flotantes.  
Una vez obtenida la información, el backend la devuelve estructurada al API, que a su vez la proporciona al frontend en un formato adecuado.  
La aplicación web transforma los datos en tablas, gráficos e imágenes y presenta los resultados al usuario.  
Este flujo ejemplifica la separación entre cliente y servidor en un sistema web y cómo la API REST sirve de puente entre la interfaz y la base de datos.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Documento/Imagenes/Diseño/UML/SD User - Página 1.pdf}
    \caption{Diagrama de secuencia de la consulta de usuario, detallando la obtencion y visualización de datos}
    \label{fig:SD User}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: Diagrama de Arquitectura    %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Arquitectura}

El diagrama de arquitectura presentado describe la organización y los componentes principales del sistema de monitoreo ambiental basado en una Red inalámbrica de sensores. El sistema se compone de tres bloques principales: la red inalámbrica de sensores, el servidor, y la visualización web.

\textbf{Red inalámbrica de sensores}\\
Este bloque incluye los nodos sensores y el nodo concentrador(Gateway). Los nodos sensores, equipados con el microcontrolador Heltec ESP32, los sensores (pH, oxígeno disuelto, turbidez, temperatura y conductividad.), y la cámara, están interconectados mediante el protocolo de comunicación LoRa. Los nodos sensores capturan datos de las condiciones del agua y los envían al Nodo Concentrador a través de LoRa.

El Nodo Concentrador tiene la función de recibir los paquetes de datos de los nodos sensores y retransmitirlos hacia la nube utilizando Wi-Fi/4G. El nodo concentrador también está integrado con AWS IoT Core, lo que le permite comunicarse con el servidor en la nube.

\textbf{Servidor}\\
El servidor en la nube se encarga de gestionar los datos enviados desde los nodos concentradores. Este bloque se divide en tres componentes principales:
\begin{itemize}
    \item Almacenamiento: Utiliza Amazon RDS para almacenar los datos estructurados (en PostgreSQL) y Amazon S3 para almacenar las imágenes procesadas y otros archivos.
    \item Backend y Frontend: El backend está basado en Amazon EC2 y utiliza Node.js y Java para procesar las solicitudes, analizar los datos y gestionar la comunicación con la base de datos y el almacenamiento. El frontend está relacionado con la interfaz de usuario que consulta los datos procesados.
    \item Conexión a través de HTTP/MQTT: El servidor gestiona la comunicación entre los diferentes módulos a través de los protocolos HTTP y MQTT. El protocolo MQTT se usa para la comunicación eficiente entre los nodos concentradores y el backend.
    \item API Rest: La API REST proporciona la capa de comunicación entre el frontend y el backend, permitiendo que la aplicación web recupere y presente los datos al usuario.
\end{itemize}

\textbf{Visualización web}\\
El bloque de visualización web está dedicado a la interfaz de usuario, donde los usuarios pueden consultar los datos monitoreados, visualizar gráficos sobre la calidad del agua y revisar las imágenes procesadas. La comunicación entre el frontend y el backend se realiza a través de la API Rest.

Este diagrama destaca las interacciones entre los componentes del sistema, incluyendo la transmisión de datos desde los nodos sensores a través del nodo concentrador, el procesamiento y almacenamiento en la nube, y la entrega de resultados al usuario final a través de la página web.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Documento/Imagenes/Diseño/Diagramadearq.pdf}
    \caption{Diagrama de arquitectura del sistema}
    \label{fig:DiagramaArq}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%             SECCIÓN: Mockups         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Diseño de Interfaz de Usuario}
\label{sec:diseno_interfaz}

La interfaz de usuario se ha diseñado bajo un enfoque web responsivo, dividida en dos entornos claramente diferenciados según el perfil del actor: un \textbf{Portal Público} de acceso libre para la consulta ciudadana y un \textbf{Portal Administrativo} para la gestión técnica del sistema. A continuación, se describen las pantallas principales diseñadas.

\subsection{Portal Público}
\label{subsec:portal_publico}

Este módulo tiene como objetivo la divulgación y transparencia de la información. No requiere autenticación y está optimizado para una navegación intuitiva.

\subsubsection*{Página de Inicio (Landing Page)}
Es el punto de entrada al sistema. Presenta el proyecto ``MONICA'', su visión y el impacto esperado. Incluye un menú de navegación superior y llamadas a la acción claras para dirigir al usuario a los datos sensados.

\begin{figure}[H]
    \centering
    % Ajusta el nombre del archivo si es necesario. 'page=1' selecciona la primera página del PDF.
    \includegraphics[width=0.9\linewidth, page=1]{Documento/Imagenes/Diseño/mockups/mockups.pdf} 
    \caption{Página de inicio del portal público con información general del proyecto.}
    \label{fig:mockup_home}
\end{figure}

\subsubsection*{Mapa Interactivo}
Permite la geolocalización de los nodos sensores sobre el río, facilitando la identificación de los puntos de monitoreo.

\begin{figure}[H]
    \centering
    % Asegúrate de que la ruta sea correcta (Diseno sin ñ)
    \includegraphics[width=0.85\linewidth, page=2]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Mapa interactivo de nodos para la geolocalización de puntos de monitoreo.}
    \label{fig:mockup_mapa}
\end{figure}

\subsubsection*{Visualización de Estadísticas}
Al seleccionar un nodo, el usuario visualiza un tablero detallado con los valores actuales de los sensores y gráficos de tendencias.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth, page=3]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Tablero de visualización de estadísticas y datos sensoriales.}
    \label{fig:mockup_stats}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth, page=4]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Grafica de visualización de estadísticas y datos sensoriales.}
    \label{fig:mockup_stats_graph}
\end{figure}

\subsubsection*{Galería de Evidencias Visuales}
Esta sección muestra las imágenes capturadas por los nodos sensores. Permite al usuario visualizar la evidencia física del estado del río (ej. presencia de residuos) filtrando por fecha y ubicación, lo cual complementa los datos numéricos.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=5]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Galería de imágenes capturadas por la red de sensores.}
    \label{fig:mockup_galeria}
\end{figure}

\subsection{Portal Administrativo}
\label{subsec:portal_admin}

Este módulo es de acceso restringido y permite la configuración y mantenimiento del sistema.

\subsubsection*{Acceso y Tablero de Control (Dashboard Admin)}
El ingreso se realiza mediante credenciales seguras. Al acceder, el administrador visualiza un resumen operativo del sistema: estado de los nodos (activos/inactivos), alertas recientes (ej. batería baja, parámetros fuera de norma) y métricas de usuarios registrados.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=7]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Portal de acceso.}
    \label{fig:mockup_login}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=8]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Tablero de control administrativo con resumen del estado del sistema.}
    \label{fig:mockup_dashboard_admin}
\end{figure}

\subsubsection*{Gestión de Nodos y Datos}
Permite a los administradores registrar nuevos nodos sensores, editar su ubicación geográfica o dar de baja dispositivos. También se incluye una vista tabular para la administración cruda de los datos recibidos, útil para auditoría y corrección de errores.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=11]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Interfaz para la gestión del inventario de nodos sensores.}
    \label{fig:mockup_nodos}
\end{figure}

\subsubsection*{Gestión de Usuarios (Rol: Dueño/Superusuario)}
Esta pantalla es crítica para la seguridad del sistema y \textbf{solo es accesible para el usuario con rol de Dueño (Owner)}. Permite registrar nuevos administradores, modificar roles y gestionar el acceso al sistema. Los usuarios con rol de ``Administrador'' estándar no tienen acceso a esta vista, garantizando un control jerárquico de la plataforma.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=10]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Panel de gestión de usuarios, exclusivo para el rol de Dueño.}
    \label{fig:mockup_usuarios}
\end{figure}

\subsubsection*{Administración de Datos}
Este módulo permite la gestión integral de la información recolectada por el sistema. Los administradores pueden visualizar, filtrar y gestionar tanto los registros de los \textbf{datos de los sensores} (parámetros físico-químicos) como el historial de \textbf{imágenes y detecciones}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=12]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Interfaz para la administración y consulta de datos de nodos sensores.}
    \label{fig:mockup_reportes_datos}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth, page=13]{Documento/Imagenes/Diseño/mockups/mockups.pdf}
    \caption{Interfaz para la administración y consulta de imagenes de nodos sensores.}
    \label{fig:mockup_reportes_img}
\end{figure}


\section{Escenario de Pruebas}
\label{sec:escenario_pruebas}

Con el objetivo de validar el funcionamiento integral del sistema MONICA antes de su despliegue final en el cuerpo de agua real, se ha diseñado un escenario de pruebas controlado en exteriores. Este entorno permite evaluar el desempeño de la red de sensores inalámbrica (WSN), la precisión de la telemetría y la eficacia del sistema de visión artificial bajo condiciones manipulables pero representativas.

\subsection{Disposición Física y Topología}
Para simular la distribución lineal del río, se dispondrá de una serie de \textbf{contenedores de agua} (capacidad mínima de 20 litros) alineados geográficamente. Cada contenedor alojará un nodo sensor completo, garantizando que las sondas se encuentren sumergidas y la cámara tenga un campo de visión despejado hacia la superficie del agua.

Cumpliendo con los objetivos de alcance del proyecto, se establece una \textbf{separación física de al menos 50 m} entre cada contenedor. Esta distancia es crítica para validar:
\begin{itemize}
    \item La potencia de la señal RSSI del enlace LoRa P2P.
    \item La capacidad de la red para realizar saltos múltiples (multi-hop) desde el nodo más lejano hasta el Gateway.
    \item La integridad de la transmisión de imágenes fragmentadas a través de distancias significativas.
\end{itemize}

El Nodo Concentrador (Gateway) se ubicará en el extremo final de la línea, proveyendo la conexión Wi-Fi necesaria para retransmitir los datos acumulados hacia el servidor en la nube.

\subsection{Protocolo de Validación de Variables}
La funcionalidad del sistema se evaluará mediante la alteración intencional y controlada de las condiciones del entorno en los contenedores:

\begin{enumerate}
    \item \textbf{Variables Físico-Químicas:} Se introducirán variaciones en el agua de los contenedores para verificar la respuesta de los sensores y la correcta visualización de los datos en el Dashboard web.
    \begin{itemize}
        \item \textit{Turbidez:} Adición progresiva de partículas en suspensión (tierra o arcilla) para elevar los niveles NTU.
        \item \textit{Temperatura:} Vertido de agua caliente para generar picos térmicos detectables.
        \item \textit{pH y Conductividad:} Disolución de soluciones ácidas/alcalinas o sales para alterar la conductividad eléctrica y el potencial de hidrógeno.
    \end{itemize}
    
    \item \textbf{Detección de Residuos (Visión Artificial):} Se simulará la presencia de contaminación flotante colocando aleatoriamente objetos representativos (botellas de PET, bolsas plásticas, latas) en la superficie del agua de los contenedores.
    \begin{itemize}
        \item El objetivo es confirmar que el sistema captura la imagen, la comprime, la transmite exitosamente al servidor y que, posteriormente, el algoritmo de IA es capaz de identificar los objetos en la fotografía reconstruida.
    \end{itemize}
\end{enumerate}

\subsection{Validación de Conectividad y Plataforma}
Finalmente, el escenario contempla la verificación del flujo de información \textit{extremo a extremo} (End-to-End). Se cotejarán los estímulos físicos aplicados en los contenedores con los registros almacenados en la base de datos y su representación gráfica en la aplicación web. 

Asimismo, se pondrán a prueba los roles de usuario definidos, verificando que la gestión de nodos sea exclusiva del administrador y que el acceso público a los datos sea fluido y en tiempo real, validando así la arquitectura completa del sistema de monitoreo.



\begin{comment}
\section{Diseño de Software}
\begin{table}[H]
\centering
\caption{Tabla Nodo.}
\label{tab:usuario}
\begin{tabular}{|l|l|l|}
\hline
\textbf{Campo}              & \textbf{Tipo de dato} & \textbf{Llave}   \\ \hline
idNodo                  & int                   & primaria         \\ \hline
Nombre                    & varchar               & N/A              \\ \hline
apellido                  & varchar               & N/A              \\ \hline
seg\_apellido             & varchar               & N/A              \\ \hline
correo                    & varchar               & N/A              \\ \hline
fecha\_nacimiento         & date                  & N/A              \\ \hline
genero                    & varchar               & N/A              \\ \hline
bandera\_administrador    & tinyint               & N/A              \\ \hline
nodo                      & int                   & N/A              \\ \hline
\end{tabular}
\end{table}

\subsection{Conexión entre nodos, concentrador y servidor}.

En el sistema propuesto, los nodos sensores distribuidos a lo largo del entorno fluvial establecen comunicación con un nodo concentrador central mediante una red inalámbrica local basada en el estándar Wi-Fi HaLow (IEEE 802.11ah). Esta tecnología opera en la banda sub-1 GHz, lo cual le otorga ventajas significativas en términos de alcance (hasta 1 km en condiciones ideales) y penetración en entornos con vegetación densa, además de un consumo energético moderado que favorece la operación autónoma con baterías o paneles solares.

El nodo concentrador cumple una función crítica dentro de la arquitectura, ya que actúa como gateway inalámbrico. Es decir, se encarga de recibir la información sensorial proveniente de los nodos HaLow y reenviarla al servidor central utilizando una interfaz de red externa. Esta interfaz puede implementarse mediante un módulo de red celular (4G/5G), ideal para zonas con baja infraestructura de conectividad, o a través de una red WLAN convencional (2.4/5 GHz) disponible en estaciones fijas cercanas al sitio de monitoreo.

Para establecer la comunicación entre el nodo concentrador y el servidor, se asume que el concentrador cuenta con dicha interfaz de red externa, permitiendo el envío de datos a través del protocolo HTTP. Esta suposición garantiza la interoperabilidad con servicios web modernos y facilita la integración con plataformas de almacenamiento, análisis o visualización de datos.

Una vez recibidos, los datos son procesados por el servidor y almacenados en una base de datos estructurada, permitiendo su consulta posterior, análisis automatizado o incluso la generación de comandos que puedan enviarse de regreso a los nodos sensores, habilitando así una comunicación bidireccional dentro del sistema.
\end{comment}

%\subsection{Base de datos}
%\subsubsection{Diseño de base de datos}
%\subsubsection{Modelo Relacional}
%\subsubsection{Diccionario de datos}

%\section{Diseño de Comunicación}
%\subsection{Diagrama de comunicación del nodo concentrador con el servidor}

%\section{Diseño de Interfaces de Usuario}
%\subsection{Diseño de Mock-up para la página web}
%\subsection{Página principal}

%\section{Modelado del Sistema}
%\subsection{Diagramas UML}
%\subsubsection{Diagramas de caso de uso}
%\subsubsection{Diagramas de secuencia}

%\section{Integración y Pruebas}
%\subsection{Integración final del sistema}
%\subsection{Escenario de pruebas}
