\begin{comment}
\chapter{Diseño}
\section{Diseño de boya para nodos sensores y nodo concentrador}
\section{Diagrama de circuito fuente de alimentacion}
\section{Diagrama de circuitos de nodo sensor}
\section{Diagrama de circuitos de nodo concentrado}
\section{Diseño de boya para nodo sensor}
\section{Diagrama de comunicacion del nodo concentrador con el servidor}
\section{Diseño de Base de datos}
\section{Modelo Relacional}
\section{Arquitectura}
\section{Diagramas UML}
\section{Diagramas de caso de uso}
\section{Diagramas de secuencia}
\section{Diccionario de Datos}
\section{Diseño de Mock-up para la pagina web}
\section{Pagina principal}
\section{Diseño de la interfaz para la página Web}
\section{Integracion Final del Sistema}
\section{Escenario de pruebas}    
\end{comment}

%opcion 2

\chapter{Diseño}

\section{Diseño del Sistema}
\subsection{Arquitectura del Sistema}

\section{Diseño de Hardware}

\subsection{Diagrama eléctrico de los nodos}
\label{sec:diagrama_electrico}

La red está conformada por nodos sensores y un nodo concentrador. Cada nodo sensor se encarga de medir parámetros físico-químicos del agua y transmitir la información recopilada hacia el nodo final, el cual actúa como concentrador. Con base en los componentes analizados y seleccionados en capítulos anteriores, se presenta el diseño esquemático del circuito electrónico del nodo sensor (Figura~\ref{fig:esquema_nodo_sensor}).

\subsection*{Descripción general del circuito}

El circuito del nodo sensor se compone de dos microcontroladores principales: un \textbf{PIC16F1823} y un \textbf{Xiao ESP32-S3}. El primero se encarga del sensado y control energético, mientras que el segundo maneja la comunicación inalámbrica con el siguiente nodo (o concentrador) a través de un módulo \textbf{Wi-Fi HaLow FGH100M}.

\begin{itemize}
    \item \textbf{PIC16F1823}: gestiona la activación secuencial de los sensores mediante un demultiplexor \textbf{74HC238}, activando solo un sensor a la vez para minimizar el consumo energético. Los sensores analógicos (pH, conductividad, OD, turbidez) son activados por MOSFETs \textbf{AO3400A} y su señal de salida se dirige a entradas ADC del PIC.
    
    \item \textbf{Sensor de temperatura DS18B20}: se conecta directamente al PIC mediante una línea digital dedicada para adquisición por protocolo 1-Wire.

    \item \textbf{Demultiplexor 74HC238}: permite seleccionar cuál de los sensores analógicos se activa en cada momento, controlado por tres líneas digitales del PIC.

    \item \textbf{Xiao ESP32-S3}: se encarga de la comunicación inalámbrica. Recibe los datos procesados por el PIC a través de un canal \textbf{UART}, y los transmite al siguiente nodo o al concentrador mediante el módulo HaLow conectado en sus pines digitales.

    \item \textbf{Módulo HaLow FGH100M}: es operado por el Xiao ESP32 y sirve como interfaz de comunicación bajo el estándar IEEE 802.11ah.

    \item \textbf{Fuente de alimentación}: el sistema se alimenta desde una batería Li-ion de 3.7 V regulada por un cargador solar \textbf{CN3065}. La salida alimenta un convertidor \textbf{step-up} que genera 5V, y un LDO que provee 3.3V para los componentes lógicos.
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{Documento/Imagenes/Diseño/Diagramas electricos/Controller Sensor_fit.pdf}
\caption{Diagrama eléctrico del control de sensores.}
\label{fig:esquema_nodo_sensor}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{Documento/Imagenes/Diseño/Diagramas electricos/microcontroller_fit.pdf}
\caption{Diagrama eléctrico comunicación inalámbrica y fuente de alimentación.}
\label{fig:esquema_nodo_sensor2}
\end{figure}


\subsection*{Funcionamiento del sistema}

Durante cada ciclo de adquisición:

\begin{enumerate}
    \item El PIC activa uno por uno los sensores mediante el demultiplexor y sus respectivas compuertas MOSFET.
    \item Cada sensor permanece encendido aproximadamente 5 segundos para estabilizar la medición.
    \item El PIC adquiere los valores analógicos o digitales, almacena las lecturas y las envía por UART al Xiao ESP32.
    \item El Xiao ESP32 activa la cámara, captura una imagen (JPG), y empaqueta los datos sensados junto con la imagen.
    \item Finalmente, activa el módulo HaLow para transmitir toda la información al nodo siguiente o al nodo concentrador.
    \item Al finalizar, el sistema entra en modo \textit{sleep} hasta el próximo ciclo.
\end{enumerate}


\section{Diseño de la Base de Datos}
\label{sec:diseno_bd}

Con base en el análisis previo, se ha diseñado un esquema de base de datos relacional implementado sobre el motor \textbf{PostgreSQL} (alojado en AWS RDS). Este diseño tiene como objetivo garantizar la persistencia, integridad y disponibilidad de los datos generados por la Red Inalámbrica de Sensores y los resultados del procesamiento de visión artificial.

\subsection{Modelo Conceptual (Entidad-Relación)}
\label{subsec:modelo_er}

El modelo de datos se estructura en torno a tres entidades principales que reflejan la arquitectura del sistema:

\begin{enumerate}
    \item \textbf{Nodos (nodes):} Representa los dispositivos físicos (nodos sensores) desplegados en el río. Almacena su configuración estática y ubicación.
    \item \textbf{Lecturas de Sensores (sensor\_readings):} Almacena las series temporales de los parámetros físico-químicos y el estado de la batería, vinculadas a un nodo específico.
    \item \textbf{Detecciones de Residuos (waste\_detections):} Almacena los metadatos resultantes del análisis de imágenes (densidad de cobertura), la referencia a la imagen almacenada (URL) y la trazabilidad del modelo de IA.
\end{enumerate}

La Figura \ref{fig:diagrama_er} ilustra el Diagrama Entidad-Relación (ER) del sistema, mostrando las relaciones de ``uno a muchos'' ($1:N$) entre los nodos y sus mediciones/detecciones.

% \begin{figure}[h!]
%     \centering
%     % Reemplaza con tu archivo de imagen. Si no tienes uno, avísame para ayudarte a describirlo.
%     \includegraphics[width=0.7\linewidth]{Documento/Imagenes/Diseño/BD/entidad-relacion.pdf}
%     \caption{Diagrama Entidad-Relación (ER) de la base de datos del sistema de monitoreo.}
%     \label{fig:diagrama_er}
% \end{figure}
\begin{figure}[h]
    \centering
    \input{Documento/Imagenes/Diseño/BD/entidad-relacion.tex}
    \caption{Diagrama Entidad-Relación (ER) de la base de datos del sistema de monitoreo.}
    \label{fig:diagrama_er}
\end{figure}


\subsection{Diseño Lógico y Diccionario de Datos}
\label{subsec:diccionario_datos}

A continuación, se detalla la estructura física de las tablas diseñadas, especificando tipos de datos y restricciones para asegurar la integridad referencial.

\subsubsection*{Tabla: Nodes (Nodos)}
Esta tabla actúa como catálogo maestro de los dispositivos autorizados en la red.

\begin{table}[H]
\centering
\caption{Diccionario de datos: Tabla \texttt{nodes}.}
\label{tab:dd_nodes}
\renewcommand{\arraystretch}{1.2}
\resizebox{\textwidth}{!}{%
\begin{tabular}{l l l p{6cm}}
\toprule
\textbf{Columna} & \textbf{Tipo de Dato} & \textbf{Restricción} & \textbf{Descripción} \\
\midrule
\texttt{node\_id} & VARCHAR(20) & PK & Identificador único del nodo (ej. "NODO\_01"). \\
\texttt{description} & VARCHAR(100) & NULL & Descripción o ubicación descriptiva (ej. "Puente Norte"). \\
\texttt{latitude} & DECIMAL(10,8) & NOT NULL & Coordenada de latitud fija del nodo. \\
\texttt{longitude} & DECIMAL(11,8) & NOT NULL & Coordenada de longitud fija del nodo. \\
\texttt{status} & VARCHAR(20) & DEFAULT 'ACTIVE' & Estado operativo (ACTIVE, INACTIVE, MAINT). \\
\texttt{last\_seen} & TIMESTAMP & NULL & Fecha/hora de la última comunicación recibida. \\
\bottomrule
\end{tabular}%
}
\end{table}

\subsubsection*{Tabla: Sensor\_Readings (Lecturas de Sensores)}
Almacena el histórico de mediciones. Se crean índices en \texttt{timestamp} y \texttt{node\_id} para optimizar las consultas de series de tiempo (RF25).

\begin{table}[H]
\centering
\caption{Diccionario de datos: Tabla \texttt{sensor\_readings}.}
\label{tab:dd_readings}
\renewcommand{\arraystretch}{1.2}
\resizebox{\textwidth}{!}{%
\begin{tabular}{l l l p{6cm}}
\toprule
\textbf{Columna} & \textbf{Tipo de Dato} & \textbf{Restricción} & \textbf{Descripción} \\
\midrule
\texttt{reading\_id} & BIGSERIAL & PK & Identificador autoincremental único de la lectura. \\
\texttt{node\_id} & VARCHAR(20) & FK & Referencia al nodo que generó el dato. \\
\texttt{timestamp} & TIMESTAMP & NOT NULL & Fecha y hora exacta de la toma de muestra. \\
\texttt{battery\_level} & DECIMAL(4,2) & NOT NULL & Nivel de voltaje de la batería (V). \\
\texttt{ph} & DECIMAL(4,2) & NULL & Valor de pH (0.00 - 14.00). \\
\texttt{temperature} & DECIMAL(5,2) & NULL & Temperatura del agua (\si{\celsius}). \\
\texttt{turbidity} & DECIMAL(6,2) & NULL & Turbidez (NTU). \\
\texttt{dissolved\_oxygen} & DECIMAL(5,2) & NULL & Oxígeno disuelto (mg/L). \\
\texttt{conductivity} & DECIMAL(8,2) & NULL & Conductividad eléctrica (\si{\micro\siemens\per\centi\meter}). \\
\bottomrule
\end{tabular}%
}
\end{table}

\subsubsection*{Tabla: Waste\_Detections (Detecciones de Residuos)}
Almacena los resultados del análisis y la evidencia visual. Se opta por almacenar la imagen directamente en la base de datos (BLOB) para garantizar la integridad referencial y simplificar la arquitectura del prototipo.

\begin{table}[H]
\centering
\caption{Diccionario de datos: Tabla \texttt{waste\_detections}.}
\label{tab:dd_detections}
\renewcommand{\arraystretch}{1.2}
\resizebox{\textwidth}{!}{%
\begin{tabular}{l l l p{6cm}}
\toprule
\textbf{Columna} & \textbf{Tipo de Dato} & \textbf{Restricción} & \textbf{Descripción} \\
\midrule
\texttt{detection\_id} & BIGSERIAL & PK & Identificador único del evento de detección. \\
\texttt{node\_id} & VARCHAR(20) & FK & Referencia al nodo (cámara origen). \\
\texttt{timestamp} & TIMESTAMP & NOT NULL & Fecha y hora de captura de la imagen. \\
\texttt{coverage\_percent} & DECIMAL(5,2) & NOT NULL & \% del área de agua cubierta por residuos ($D_{cob}$). \\
\texttt{image\_data} & BYTEA & NOT NULL & Binario de la imagen JPEG (aprox. 90 kB). \\
\texttt{model\_version} & VARCHAR(50) & NOT NULL & Versión del modelo YOLO utilizado. \\
\texttt{confidence} & DECIMAL(3,2) & NULL & Nivel de confianza promedio de la detección. \\
\bottomrule
\end{tabular}%
}
\end{table}


\subsubsection*{Tabla: Users (Usuarios del Sistema)}
Almacena las credenciales de acceso para los administradores y el dueño del sistema. El control de privilegios se gestiona mediante el campo de rol.

\begin{table}[h!]
\centering
\caption{Diccionario de datos: Tabla \texttt{users}.}
\label{tab:dd_users}
\renewcommand{\arraystretch}{1.2}
\resizebox{\textwidth}{!}{%
\begin{tabular}{l l l p{6cm}}
\toprule
\textbf{Columna} & \textbf{Tipo de Dato} & \textbf{Restricción} & \textbf{Descripción} \\
\midrule
\texttt{user\_id} & BIGSERIAL & PK & Identificador único del usuario. \\
\texttt{full\_name} & VARCHAR(100) & NOT NULL & Nombre completo del personal. \\
\texttt{email} & VARCHAR(100) & UNIQUE & Correo electrónico (usado para Login). \\
\texttt{password\_hash} & VARCHAR(255) & NOT NULL & Contraseña cifrada (Hash). \\
\texttt{role} & VARCHAR(20) & NOT NULL & Nivel de acceso: 'OWNER' o 'ADMIN'. \\
\texttt{created\_at} & TIMESTAMP & DEFAULT NOW() & Fecha de creación de la cuenta. \\
\texttt{is\_active} & BOOLEAN & DEFAULT TRUE & Indica si el usuario tiene permiso de acceso. \\
\bottomrule
\end{tabular}%
}
\end{table}










\section{Diseño de Software}
\begin{table}[H]
\centering
\caption{Tabla Nodo.}
\label{tab:usuario}
\begin{tabular}{|l|l|l|}
\hline
\textbf{Campo}              & \textbf{Tipo de dato} & \textbf{Llave}   \\ \hline
idNodo                  & int                   & primaria         \\ \hline
Nombre                    & varchar               & N/A              \\ \hline
apellido                  & varchar               & N/A              \\ \hline
seg\_apellido             & varchar               & N/A              \\ \hline
correo                    & varchar               & N/A              \\ \hline
fecha\_nacimiento         & date                  & N/A              \\ \hline
genero                    & varchar               & N/A              \\ \hline
bandera\_administrador    & tinyint               & N/A              \\ \hline
nodo                      & int                   & N/A              \\ \hline
\end{tabular}
\end{table}

\subsection{Conexión entre nodos, concentrador y servidor}.

En el sistema propuesto, los nodos sensores distribuidos a lo largo del entorno fluvial establecen comunicación con un nodo concentrador central mediante una red inalámbrica local basada en el estándar Wi-Fi HaLow (IEEE 802.11ah). Esta tecnología opera en la banda sub-1 GHz, lo cual le otorga ventajas significativas en términos de alcance (hasta 1 km en condiciones ideales) y penetración en entornos con vegetación densa, además de un consumo energético moderado que favorece la operación autónoma con baterías o paneles solares.

El nodo concentrador cumple una función crítica dentro de la arquitectura, ya que actúa como gateway inalámbrico. Es decir, se encarga de recibir la información sensorial proveniente de los nodos HaLow y reenviarla al servidor central utilizando una interfaz de red externa. Esta interfaz puede implementarse mediante un módulo de red celular (4G/5G), ideal para zonas con baja infraestructura de conectividad, o a través de una red WLAN convencional (2.4/5 GHz) disponible en estaciones fijas cercanas al sitio de monitoreo.

Para establecer la comunicación entre el nodo concentrador y el servidor, se asume que el concentrador cuenta con dicha interfaz de red externa, permitiendo el envío de datos a través del protocolo HTTP. Esta suposición garantiza la interoperabilidad con servicios web modernos y facilita la integración con plataformas de almacenamiento, análisis o visualización de datos.

Una vez recibidos, los datos son procesados por el servidor y almacenados en una base de datos estructurada, permitiendo su consulta posterior, análisis automatizado o incluso la generación de comandos que puedan enviarse de regreso a los nodos sensores, habilitando así una comunicación bidireccional dentro del sistema.


\subsection{Base de datos}
\subsubsection{Diseño de base de datos}
\subsubsection{Modelo Relacional}
\subsubsection{Diccionario de datos}

\section{Diseño de Comunicación}
\subsection{Diagrama de comunicación del nodo concentrador con el servidor}

\section{Diseño de Interfaces de Usuario}
\subsection{Diseño de Mock-up para la página web}
\subsection{Página principal}

\section{Modelado del Sistema}
\subsection{Diagramas UML}
\subsubsection{Diagramas de caso de uso}
\subsubsection{Diagramas de secuencia}

\section{Integración y Pruebas}
\subsection{Integración final del sistema}
\subsection{Escenario de pruebas}
